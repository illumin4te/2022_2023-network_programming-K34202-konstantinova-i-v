University: ITMO University Faculty: FICT Course: Network programming Year: 2022/2023 Group: K34202 Author: Konstantinova Iuliia Vyacheslavovna Lab: Lab1 Date of create: 15.02.2023 Date of finished:

Цель: изучить синтаксис языка программирования P4 и выполнить 2 обучающих задания от Open network foundation для ознакомления на практике с P4.

Ход работы:

В начале работы установлен Vagrant для запуска необходимой виртуальной машины. Затем папка виртуальной машины поднята при помощи команды vagrant up. Затем был отрыт интерфейс виртуальной машины и выполнен вход в аккаунт пользователя p4 (Рис.1).
 
 ![image](https://user-images.githubusercontent.com/90499135/230215835-cbdbf81a-40aa-4c39-b63b-23c64142c4ff.png)

Рисунок 1 – Вход в аккаунт пользователя p4

Далее в терминале выполнен вход в папку первого задания, где расположен файл basic.p4. Проверен запуск и работа mininet (Рис.2).
 
 ![image](https://user-images.githubusercontent.com/90499135/230215876-47a1cc36-fea8-4292-8515-63d8fa1219cd.png)

Рисунок 2 – Проверка работы mininet

Далее было необходимо дописать программу так, чтобы между роутерами шёл пинг. Задача соятояла в том, чтобы при пересылке IPv4 коммутатор выполнял следующие действия для каждого пакета: обновление MAC-адреса источника и получателя, уменьшение TTL в заголовке IP и пересылка пакета из соответствующего порта. Коммутатор имеет единую таблицу, которую при помощи P4 необходимо заполнить правилами. Каждое правило сопоставляет IP-адрес с MAC-адресом и выходным портом для следующей пересылки. Должна быть реализована следующая схема связи (Рис.3).
 
 ![image](https://user-images.githubusercontent.com/90499135/230215908-97c20c9f-746d-4d47-8c9e-f6721200bcea.png)

Рисунок 3 – Схема сети

Далее подключены библиотеки. Первая библиотека — это основная библиотека P4, в которой объявляются встроенные конструкции P4. v1model необходима для работы с коммутаторами, которые даны по условию. Задана константа длиной в 16 бит с названием TYPE_IPV4 (Рис.4).
 
 ![image](https://user-images.githubusercontent.com/90499135/230215931-e5cc11d4-98ad-4bb9-86e2-30a31434bcae.png)

Рисунок 4 – Добавление библиотек и константы

Далее в заголовках созданы ещё несколько типов переменных. Также прописано, из чего состоит пакет ethernet, заданы мак адреса отправителя и получателя и тип кадра (Рис.5). Заданы ethernet и ipv4.
 
 ![image](https://user-images.githubusercontent.com/90499135/230215971-a60138a3-5b9b-4662-a149-60ffaa731c3c.png)

Рисунок 5 – Задание параметров

Далее необходимо было работать с частью, отвечающей за парсеры. Парсер в P4 — это функция, которая отображает пакеты в заголовках и метаданные, написанные уже на языке конечного автомата. Прописан ethernet parser (Рис.6).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216000-bb20af96-a669-4813-8128-06926b58027d.png)

Рисунок 6 – Часть с парсерами

Далее прописаны действия с Ingress, который отвечает за входящий трафик (Рис.7).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216026-51221518-2f1a-4f39-a90b-c1e41475613b.png)

Рисунок 7 – Ingress 

IPV4 table уже задано, прописана таблица, являющаяся фундаментальная частью пайплайна. Она указывает, какие данные сопоставлять и каким образом, а также список действий. Прописано условие проверки правильности заголовка ipv4 (Рис.8).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216089-e267329e-8018-486c-b01f-6fb3288fbe51.png)

Рисунок 8 – Условие проверки заголовка ipv4

Затем вызвана функция из p4.core, собирающая заголовки обратно в сформированный пакет (Рис.9). Затем прописан вызов описанных функций.
 
 ![image](https://user-images.githubusercontent.com/90499135/230216151-1182800e-d9e3-4318-8567-fbad85e4cdad.png)

Рисунок 9 – Функция из p4.core

Отправлен пинг с h1 на h2 (схема сети выше). Всё настроено корректно (Рис.10).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216209-ad9b6a58-2a20-400f-aa65-88717e0ab934.png)

Рисунок 10 – Пинг с h1 на h2

Далее необходимо определить новый тип заголовка для инкапсуляции IP-пакета и изменить код коммутатора, чтобы он вместо этого определял порт назначения, используя новый заголовок туннеля. Новый тип заголовка должен содержать идентификатор протокола, указывающий тип инкапсулируемого пакета, а также идентификатор получателя, который использован для маршрутизации. Представлена схема сети (Рис.11).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216266-01620e61-4d3c-40aa-a9b3-24aef6e74210.png)

Рисунок 11 – Схема сети

Была добавлена ещё одна константа, необходимая для туннелирования (Рис.12). Добавлен новый тип заголовка, включающий в себя id протокола и адреса назначения. Этот тип добавлен в структуру заголовков. 
 
 ![image](https://user-images.githubusercontent.com/90499135/230216296-530b25ae-deec-465a-806c-651fd95630c4.png)

Рисунок 12 – Добавление константы

Создан ещё один стейт в парсерах, по аналогии с уже существующими ethernet и ipv4. Он добавлен в оператор select в ethernet, который идёт до него, и в него включен оператор select, указывающий на ipv4 (Рис.13).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216335-8e0cc0b3-104d-4d96-bdfe-749e59daebc5.png)

Рисунок 13 – Новый стейт

Затем был указан порт в метадате. Создана таблица, прописанными ранее ключом и действием (Рис.14).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216370-4b35bf7e-943f-40b8-bb95-a118ce0d58a7.png)

Рисунок 14 – Создание таблицы

Затем прописаны условия проверки. Проверяем работоспособность командой make run. Через мининет запущены два мини терминала устройств (Рис.15).
 
 ![image](https://user-images.githubusercontent.com/90499135/230216405-0965aaa8-2812-4927-bd81-4c9f3534f7f1.png)

Рисунок 15 – Проверка работоспособности

На h2 поднят сервер, после чего с h1на него отправлен пакет. Пакет получен до получателем (Рис.16). Проверена правильность конфигурирования. 
 
 ![image](https://user-images.githubusercontent.com/90499135/230216505-c52b3b2e-728e-4a7d-a8d1-f8deaa6fbdd1.png)

Рисунок 16 – Получение пакета

Вывод: в ходе выполнения работы все задачи выполнены, реализованы перенаправление пакетов и туннелирование при помощи языка программирования P4.
